<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
			<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
			<title>陽明交大-醫學數位內容-學習平台登入網頁</title>
			<script src="js/sha256.js"></script>
			<script src="js/setting.js"></script>
			<link href="css/style.css" rel="stylesheet" type="text/css" media="screen" />
	</head>
<body>
	<div class="center">
		<h1 align="center">陽明交大-醫學數位內容<br>學習平台登入網頁</h1>
		<form id="form1">
			<table align="center" style="border: solid 2px gray;" >	
				<tr><td>帳號 (Email) <font color="red"> *</font></td><td>:&nbsp;<input type="text" id="pUserID"><br></td></tr>
				<tr><td>密碼 <font color="red"> *</font></td><td>:&nbsp;<input type="password" id="pPassword" onkeyup="SHA256PWD.value = sha256(this.value);"></td></tr>
				<tr><td colspan="2" align="right"><input type="button" value="Submit" onclick="getData()"></td></tr>
			</table>
			<p align="center">
				<a href="createPerson.html" target="_blank">報名請點我</a>    &nbsp;
			</p>
			<input type="hidden" id="SHA256PWD">
			
			<div align="left" style="margin-top: 30px">無法登入或忘記密碼請聯絡陽明交大 施岳勳<br>電話：0955740405<br>郵件：donaldonal71462@hotmail.com'</div>
		</form>
	</div>
	<script>
		let UserID;
		
		function checkUsername(res){ 
			let password= document.getElementById('pPassword').value;
			let encPassword= document.getElementById('SHA256PWD').value;
	
			if (res.total == 0) alert('帳號不存在!');
			else{
				var retPersonID= res.entry[0].resource.id;
				var retPassword= res.entry[0].resource.identifier[1].value;
				var retName= res.entry[0].resource.name[0].text;
				//check json hasOwnProperty [patient] 
				if(res.entry[0].resource.hasOwnProperty('link'))
					globalPatientID= res.entry[0].resource.link[0].target.reference;	//patient ID
				else
					globalPatientID='-1';
			}
			
			if(res.total==1 && encPassword!=retPassword)	alert('Wrong password!');		
			else if(res.total==1 && encPassword==retPassword){
				var queryParam= 'patientID=' + globalPatientID + '&name=' + encodeURIComponent( retName )+ '&personID=' +  retPersonID;
				window.open('index.html?' + queryParam,"_self");
			}
			else{
				alert('系統錯誤! 請聯絡慈大醫資龍昱璇學姊，\n電話：0965006102\n郵件：108316107@gms.tcu.edu.tw');
			}
		}
		
		function getData(){
			if(checkRequiredField(2)){
				UserID= document.getElementById('pUserID').value;
				let urlStr= FHIRserver + 'Person?identifier=UserID|' + UserID;
				HTTPGetData(urlStr, "loginVerify");
			}
		}
	</script>
</body>
</html>